steps:
  # ==========================================
  # 1. Build & Push Backend
  # ==========================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build Backend'
    args: 
      - 'build'
      - '-f'
      - 'Dockerfile.backend'
      - '-t'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_BACKEND_SERVICE_NAME}:$COMMIT_SHA'
      - '-t'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_BACKEND_SERVICE_NAME}:latest'
      - '.'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push Backend'
    args: 
      - 'push'
      - '--all-tags'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_BACKEND_SERVICE_NAME}'

  # ==========================================
  # 2. Deploy Backend
  # ==========================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Deploy Backend'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - '${_BACKEND_SERVICE_NAME}'
      - '--image'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_BACKEND_SERVICE_NAME}:$COMMIT_SHA'
      - '--region'
      - '${_REGION}'
      - '--allow-unauthenticated'
      - '--service-account'
      - '${_CLOUD_RUN_SERVICE_ACCOUNT}'
      - '--add-cloudsql-instances'
      - '${_INSTANCE_CONNECTION_NAME}'
      - '--set-secrets'
      - 'DB_PASS=streamhub-db-password:latest'
      - '--set-env-vars'
      - 'NODE_ENV=production,PORT=8080,ENABLE_RTMP=false,INSTANCE_CONNECTION_NAME=${_INSTANCE_CONNECTION_NAME},DB_USER=${_DB_USER},DB_NAME=${_DB_NAME},REDIS_HOST=${_REDIS_HOST},REDIS_PORT=${_REDIS_PORT}'

  # ==========================================
  # 3. Build & Push Frontend
  # ==========================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Configure Frontend Env'
    entrypoint: bash
    script: |
      echo "VITE_BACKEND_URL=${_VITE_BACKEND_URL}" > .env
      echo "VITE_GEMINI_API_KEY=${_VITE_GEMINI_API_KEY}" >> .env
      if [ -z "${_VITE_BACKEND_URL}" ]; then
        echo "Fetching deployed backend URL..."
        BACKEND_URL=$(gcloud run services describe ${_BACKEND_SERVICE_NAME} --region ${_REGION} --format 'value(status.url)')
        echo "VITE_BACKEND_URL=$BACKEND_URL" >> .env
      fi

  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build Frontend'
    args: 
      - 'build'
      - '-f'
      - 'Dockerfile'
      - '-t'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_FRONTEND_SERVICE_NAME}:$COMMIT_SHA'
      - '-t'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_FRONTEND_SERVICE_NAME}:latest'
      - '.'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push Frontend'
    args: 
      - 'push'
      - '--all-tags'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_FRONTEND_SERVICE_NAME}'

  # ==========================================
  # 4. Deploy Frontend
  # ==========================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Deploy Frontend'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - '${_FRONTEND_SERVICE_NAME}'
      - '--image'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_FRONTEND_SERVICE_NAME}:$COMMIT_SHA'
      - '--region'
      - '${_REGION}'
      - '--allow-unauthenticated'
      - '--service-account'
      - '${_CLOUD_RUN_SERVICE_ACCOUNT}'

# ==========================================
# Options & Config
# ==========================================
# logsBucket: 'gs://streamhub-pro' 

substitutions:
  _REGION: us-west1
  _REPO_NAME: cloud-run-source-deploy
  _BACKEND_SERVICE_NAME: streamhub-backend
  _FRONTEND_SERVICE_NAME: streamhub-frontend
  _INSTANCE_CONNECTION_NAME: 'your-project:your-region:your-instance'
  _DB_USER: streamhub
  _DB_NAME: streamhub
  _REDIS_HOST: 'redis-host-ip'
  _REDIS_PORT: '6379'
  _VITE_BACKEND_URL: ''
  _VITE_GEMINI_API_KEY: ''
  _CLOUD_RUN_SERVICE_ACCOUNT: 'streamhub-run-sa@${PROJECT_ID}.iam.gserviceaccount.com'

images:
  - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_BACKEND_SERVICE_NAME}:$COMMIT_SHA'
  - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_BACKEND_SERVICE_NAME}:latest'
  - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_FRONTEND_SERVICE_NAME}:$COMMIT_SHA'
  - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_FRONTEND_SERVICE_NAME}:latest'
