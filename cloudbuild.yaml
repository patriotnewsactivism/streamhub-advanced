steps:
  # ==========================================
  # 1. Build & Push Backend
  # ==========================================
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build Backend'
    args: 
      - 'build'
      - '-f'
      - 'Dockerfile.backend'
      - '-t'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_BACKEND_SERVICE_NAME}:$COMMIT_SHA'
      - '-t'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_BACKEND_SERVICE_NAME}:latest'
      - '.'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push Backend'
    args: 
      - 'push'
      - '--all-tags'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_BACKEND_SERVICE_NAME}'

  # ==========================================
  # 2. Deploy Backend (to get URL for frontend)
  # ==========================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Deploy Backend'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - '${_BACKEND_SERVICE_NAME}'
      - '--image'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_BACKEND_SERVICE_NAME}:$COMMIT_SHA'
      - '--region'
      - '${_REGION}'
      - '--allow-unauthenticated'
      - '--set-secrets'
      - 'DB_PASS=streamhub-db-password:latest'
      - '--set-env-vars'
      - 'NODE_ENV=production,INSTANCE_CONNECTION_NAME=${_INSTANCE_CONNECTION_NAME},DB_USER=${_DB_USER},DB_NAME=${_DB_NAME},REDIS_HOST=${_REDIS_HOST},REDIS_PORT=${_REDIS_PORT}'

  # ==========================================
  # 3. Build & Push Frontend
  # ==========================================
  # Create a .env file so Vite picks up the Backend URL during build
  - name: 'bash'
    id: 'Configure Frontend Env'
    script: |
      echo "VITE_BACKEND_URL=${_VITE_BACKEND_URL}" > .env
      echo "VITE_GEMINI_API_KEY=${_VITE_GEMINI_API_KEY}" >> .env
      # If VITE_BACKEND_URL is not set manually, try to fetch it from the deployed service
      if [ -z "${_VITE_BACKEND_URL}" ]; then
        echo "Fetching deployed backend URL..."
        BACKEND_URL=$(gcloud run services describe ${_BACKEND_SERVICE_NAME} --region ${_REGION} --format 'value(status.url)')
        echo "VITE_BACKEND_URL=$BACKEND_URL" >> .env
        echo "Detected Backend URL: $BACKEND_URL"
      fi

  - name: 'gcr.io/cloud-builders/docker'
    id: 'Build Frontend'
    args: 
      - 'build'
      - '-f'
      - 'Dockerfile'
      - '-t'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_FRONTEND_SERVICE_NAME}:$COMMIT_SHA'
      - '-t'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_FRONTEND_SERVICE_NAME}:latest'
      - '.'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'Push Frontend'
    args: 
      - 'push'
      - '--all-tags'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_FRONTEND_SERVICE_NAME}'

  # ==========================================
  # 4. Deploy Frontend
  # ==========================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Deploy Frontend'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - '${_FRONTEND_SERVICE_NAME}'
      - '--image'
      - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_FRONTEND_SERVICE_NAME}:$COMMIT_SHA'
      - '--region'
      - '${_REGION}'
      - '--allow-unauthenticated'

# ==========================================
# Configuration Substitutions
# ==========================================
substitutions:
  _REGION: us-west1
  _REPO_NAME: cloud-run-source-deploy
  _BACKEND_SERVICE_NAME: streamhub-backend
  _FRONTEND_SERVICE_NAME: streamhub-frontend
  
  # Database Config (Default matches your deploy.sh)
  _INSTANCE_CONNECTION_NAME: 'your-project:your-region:your-instance'
  _DB_USER: streamhub
  _DB_NAME: streamhub
  _REDIS_HOST: 'redis-host-ip' # Replace with actual Redis IP if using VPC
  _REDIS_PORT: '6379'
  
  # Frontend Config
  _VITE_BACKEND_URL: '' # Leave empty to auto-detect from backend deployment
  _VITE_GEMINI_API_KEY: '' # Optional: Provide key for AI features

images:
  - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_BACKEND_SERVICE_NAME}:$COMMIT_SHA'
  - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_BACKEND_SERVICE_NAME}:latest'
  - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_FRONTEND_SERVICE_NAME}:$COMMIT_SHA'
  - '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO_NAME}/${_FRONTEND_SERVICE_NAME}:latest'

options:
  logging: CLOUD_LOGGING_ONLY